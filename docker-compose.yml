services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    labels:
      - traefik.enable=true

      # Middleware: Redirect to HTTPS
      - traefik.http.middlewares.lafela-force-secure.redirectscheme.scheme=https
      - traefik.http.middlewares.lafela-force-secure.redirectscheme.permanent=true

      # HTTP Router: Listens on web (80), redirects to HTTPS
      - traefik.http.routers.lafela-http.rule=Host(`lafela.lt`)
      - traefik.http.routers.lafela-http.entrypoints=web
      - traefik.http.routers.lafela-http.middlewares=lafela-force-secure

      # HTTPS Router: Listens on websecure (443), serves app
      - traefik.http.routers.lafela-https.rule=Host(`lafela.lt`)
      - traefik.http.routers.lafela-https.entrypoints=websecure
      - traefik.http.routers.lafela-https.tls=true
      - traefik.http.routers.lafela-https.tls.certresolver=letsencrypt
      - traefik.http.routers.lafela-https.service=lafela

      # Service
      - traefik.http.services.lafela.loadbalancer.server.port=3000
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme}
      - SESSION_SECRET=${SESSION_SECRET:-change-this-to-random-string}
    volumes:
      - sqlite_data:/app/data
    networks:
      - traefik-proxy

volumes:
  sqlite_data:


networks:
  traefik-proxy:
    external: true
